<!DOCTYPE html>
<html>
<head>
    <title>文件内容检索系统</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css ">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js "></script>
    <style>
        html, body { height: 100%; }
        .container { height: 100%; }
        #result {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: auto;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            max-height: calc(70vh);
            min-height: 200px;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
        }
        @media (max-width: 768px) {
            #result { max-height: calc(60vh); min-height: 150px; }
        }

        /* Progress box styling */
        .progress-wrap {
            margin-top: 12px;
            background: linear-gradient(180deg, #ffffff, #f7f9fb);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.04);
            display: none; /* hidden by default */
            align-items: center;
        }
        .progress-info {
            display:flex;
            align-items:center;
            gap:12px;
            width:100%;
        }
        .progress-label {
            min-width: 140px;
            font-size: 0.95rem;
            color:#495057;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .progress-status-badge {
            font-size: 0.75rem;
            padding: 0.25em 0.5em;
            border-radius: 999px;
        }
        /* Smooth progress bar animation */
        #progressBar { transition: width 220ms ease-in-out; }
        .no-transition { transition: none !important; }

        /* match display under title */
        #matchDisplay {
            font-weight: 600;
            color: #1f618d;
            margin-bottom: 8px;
        }

        /* small responsive spacing */
        @media (max-width: 576px) {
            .progress-label { min-width: 100px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
            <h2 class="text-center mb-2">文件内容检索系统</h2>

            <!-- 专属一行显示匹配数（居中、独占一行） -->
            <div id="matchDisplay" class="text-center">匹配：0 条</div>

            <form class="mb-2 px-2 py-3 bg-white rounded shadow-sm">
                <div class="row g-2 align-items-center">
                    <div class="col-12 col-md-5 mb-2 mb-md-0">
                        <input type="text" id="keyword" class="form-control" placeholder="输入关键词" style="font-size:1.1em;">
                    </div>
                    <div class="col-6 col-md-2">
                        <input type="number" id="context_before" class="form-control" placeholder="上文" min="0">
                    </div>
                    <div class="col-6 col-md-2">
                        <input type="number" id="context_after" class="form-control" placeholder="下文" min="0">
                    </div>
                    <div class="col-12 col-md-3 mt-2 mt-md-0">
                        <select id="file" class="form-control">
                            <option value="">所有文件 (默认)</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3 g-2">
                    <div class="col-6 col-md-3">
                        <button type="button" id="submitBtn" class="btn btn-outline-primary w-100" onclick="sendKeyword()">提交</button>
                    </div>
                    <div class="col-6 col-md-3">
                        <button type="button" id="cancelBtn" class="btn btn-outline-danger w-100">取消</button>
                    </div>
                    <div class="col-6 col-md-3 mt-2 mt-md-0">
                        <button type="button" id="clearBtn" class="btn btn-outline-warning w-100" onclick="clearResult()">清空</button>
                    </div>
                    <div class="col-6 col-md-3 mt-2 mt-md-0">
                        <button type="button" id="exportBtn" class="btn btn-outline-secondary w-100" onclick="exportResult()">导出</button>
                    </div>
                </div>

                <!-- Progress area (hidden by default) -->
                <div id="progressWrap" class="progress-wrap mt-3">
                    <div class="progress-info w-100">
                        <div class="progress-label">
                            <strong id="progressTitle">检索进度</strong>
                            <span id="loadingSpinner" class="spinner-border spinner-border-sm text-secondary" style="display:none;" role="status" aria-hidden="true"></span>
                            <span id="progressBadge" class="badge badge-secondary progress-status-badge">空闲</span>
                        </div>
                        <div class="flex-fill">
                            <div class="progress" style="height:12px;">
                                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-1" style="font-size:0.85rem;color:#6c757d;">
                                <div id="progressDetail"></div>
                                <div id="progressPercent">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end progress -->
            </form>
            <pre id="result" class="mt-4"></pre>
        </div>
    </div>
</div>
<script>
var socket = io({path: '/io'});

let running = false;
let pendingSubmit = false;
let lastSubmitAt = 0;
const DEBOUNCE_MS = 600;
let receivedChunks = 0;
let matches = 0;
let files_total = 0;
let files_done = 0;
let progressHideTimeout = null;
// 动态文件类型与计时
let fileType = 'other';
let lastVisualPct = 0; // 单调进度，避免回退抖动

// 终止控制器与跟踪中的请求集合
let searchController = null;
const inflightControllers = new Set();
// 新增：标记是否发生过取消，避免后续 Done 误覆盖
let wasCancelled = false;

function classifyFileType(nameLower) {
    const n = (nameLower || '').toLowerCase();
    if (/(\.zip|\.jar|\.war|\.rar|\.7z)$/i.test(n)) return 'archive';
    if (/(\.gz|\.bz2|\.xz|\.lz4|\.lzma)$/i.test(n)) return 'compressed';
    if (/\.xlsx$/i.test(n)) return 'excel';
    if (/\.xls$/i.test(n)) return 'excel';
    if (/\.csv$/i.test(n)) return 'csv';
    if (/(\.txt|\.log|\.json|\.xml|\.md|\.ini|\.yaml|\.yml)$/i.test(n)) return 'text';
    return 'other';
}
function updateFileTypeUI(ft) {
    const icon = document.getElementById('fileTypeIcon');
    const explain = document.getElementById('fileTypeExplain');
    icon.className = 'text-muted';
    let cls = 'fa-regular fa-file';
    let exp = '计算：仅检索';
    if (ft === 'archive') { cls = 'fa-solid fa-box-archive'; exp = '计算：解压 + 检索'; }
    else if (ft === 'compressed') { cls = 'fa-solid fa-file-zipper'; exp = '计算：解压 + 检索'; }
    else if (ft === 'excel') { cls = 'fa-solid fa-file-excel'; exp = '计算：仅检索（表格转文本）'; }
    else if (ft === 'csv') { cls = 'fa-solid fa-file-csv'; exp = '计算：仅检索'; }
    else if (ft === 'text') { cls = 'fa-regular fa-file-lines'; exp = '计算：仅检索'; }
    icon.classList.add(...cls.split(' '));
    explain.textContent = exp;
}

function showProgress() {
    const wrap = document.getElementById('progressWrap');
    wrap.style.display = 'flex';
}
function hideProgress() {
    const wrap = document.getElementById('progressWrap');
    wrap.style.display = 'none';
}
// 统一跟踪中的 Fetch，支持取消时全部终止
function trackedFetch(url, options = {}, track = true) {
    const controller = new AbortController();
    const opts = Object.assign({}, options, { signal: controller.signal });
    if (track) inflightControllers.add(controller);
    return fetch(url, opts).finally(() => {
        if (track) inflightControllers.delete(controller);
    });
}
function cancelAllFetches() {
    inflightControllers.forEach(ctrl => {
        try { ctrl.abort(); } catch (e) {}
    });
    inflightControllers.clear();
}
function setProgressState(state, opts = {}) {
    // state: 'idle' | 'running' | 'done' | 'cancelled' | 'error'
    const bar = document.getElementById('progressBar');
    const badge = document.getElementById('progressBadge');
    const detail = document.getElementById('progressDetail');
    const percent = document.getElementById('progressPercent');
    const matchEl = document.getElementById('matchDisplay');

    if (state === 'idle') {
        bar.style.width = '0%';
        bar.className = 'progress-bar';
        bar.classList.remove('no-transition');
        badge.className = 'badge badge-secondary progress-status-badge';
        badge.textContent = '空闲';
        detail.textContent = '';
        percent.textContent = '0%';
        lastVisualPct = 0;
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'none';
    } else if (state === 'running') {
        showProgress();
        let pct = typeof opts.pct === 'number' ? opts.pct : 5;
        // 超过 100% 自动修正
        pct = Math.max(0, Math.min(100, pct));
        bar.classList.remove('no-transition');
        bar.style.width = pct + '%';
        bar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-info';
        badge.className = 'badge badge-info progress-status-badge';
        badge.textContent = opts.text || '检索中';
        detail.textContent = '';
        matchEl.textContent = `匹配：${matches} 条`;
        percent.textContent = (pct) + '%';
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'inline-block';
    } else if (state === 'done') {
        // 压缩/归档完成时：禁用宽度过渡，瞬时显示 100%
        if (opts && (opts.fileType === 'compressed' || opts.fileType === 'archive')) {
            bar.classList.add('no-transition');
        } else {
            bar.classList.remove('no-transition');
        }
        bar.style.width = '100%';
        if (opts && opts.preserveBarStyle) {
            // 保留原有进度条风格，仅把颜色改为绿色，避免视觉上的“切换”
            bar.classList.remove('bg-info');
            bar.classList.add('bg-success');
        } else {
            bar.className = 'progress-bar bg-success';
        }
        badge.className = 'badge badge-success progress-status-badge';
        badge.textContent = '完成';
        detail.textContent = '';
        // 确保显示最新的匹配数（可能已在progress事件中更新）
        matchEl.textContent = `匹配：${matches} 条`;
        percent.textContent = '100%';
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'none';
    } else if (state === 'cancelled') {
        bar.style.width = '100%';
        bar.className = 'progress-bar bg-danger';
        badge.className = 'badge badge-danger progress-status-badge';
        badge.textContent = '已取消';
        detail.textContent = '';
        matchEl.textContent = `匹配：${matches} 条`;
        percent.textContent = '已取消';
        lastVisualPct = 100;
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'none';
    } else if (state === 'error') {
        showProgress();
        bar.style.width = '100%';
        bar.className = 'progress-bar bg-warning';
        badge.className = 'badge badge-warning progress-status-badge';
        badge.textContent = '错误';
        detail.textContent = opts.msg || '出现错误';
        percent.textContent = '错误';
        lastVisualPct = 100;
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'none';
    }
}

function disableControls(val) {
    document.getElementById('submitBtn').disabled = val;
    document.getElementById('file').disabled = val;
    document.getElementById('context_before').disabled = val;
    document.getElementById('context_after').disabled = val;
    // 取消按钮保持可点击，随时允许中断
    document.getElementById('cancelBtn').disabled = false;
    document.getElementById('exportBtn').disabled = val; // prevent export during running
}

window.addEventListener('DOMContentLoaded', function(){
    trackedFetch('/files', {}, true)
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(list => {
        const sel = document.getElementById('file');
        list.forEach(fn => {
            const opt = document.createElement('option');
            opt.value = fn; opt.textContent = fn;
            sel.appendChild(opt);
        });
    }).catch(() => {});
    // init progress idle
    setProgressState('idle');
    // cancel button initially disabled
    document.getElementById('cancelBtn').disabled = true;
    // 绑定取消按钮事件监听器（统一使用 addEventListener）
    const cancelBtnEl = document.getElementById('cancelBtn');
    cancelBtnEl.addEventListener('click', function(e){
        e.preventDefault();
        cancelSearch();
    });
});

socket.on('message', data => {
    if (!data || typeof data.message !== 'string') return;
    const text = data.message.replace(/\r?\n/g, '\n');

    // 取消：恢复所有控件与状态
    if (text.includes('??? Cancelled ???')) {
        running = false;
        pendingSubmit = false;
        wasCancelled = true;
        lastVisualPct = 100;
        setProgressState('cancelled');
        disableControls(false);
        document.getElementById('submitBtn').disabled = false;
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => hideProgress(), 1200);
        return;
    }

    // 服务端已开始检索：进入运行态
    if (text.includes('Started')) {
        // 若刚刚发生过取消，则忽略过期的 Started 事件，避免需要再次点击取消
        if (wasCancelled) { return; }
        running = true;
        pendingSubmit = false;
        receivedChunks = 0;
        matches = 0; // 每次新启动重置匹配显示
        files_total = 0;
        files_done = 0;
        lastVisualPct = 0;
        
        document.getElementById('matchDisplay').textContent = `匹配：${matches} 条`;
        setProgressState('running', {pct:5, text: '开始检索'});
        disableControls(true);
        document.getElementById('cancelBtn').disabled = false;
        return;
    }

    // 服务端忙：提示并恢复按钮（防止长时间不可点击）
    if (text.includes('Busy')) {
        pendingSubmit = false;
        setProgressState('error', {msg: '服务器忙，请稍后再试'});
        disableControls(false);
        document.getElementById('submitBtn').disabled = false;
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => hideProgress(), 1200);
        return;
    }

    // 完成：退出运行态并恢复控件
    if (text.includes('Done')) {
        if (wasCancelled) { return; }
        running = false;
        pendingSubmit = false;
        lastVisualPct = 100;
        setProgressState('done', {fileType, preserveBarStyle: (fileType === 'compressed')});
        disableControls(false);
        document.getElementById('submitBtn').disabled = false;
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => {
            hideProgress();
        }, 1200);
        return;
    }

    // 静默：屏蔽非文件内容（服务端提示/错误以 "??" 开头）
    if (/^\s*\?\?/.test(text)) {
        return;
    }

    // 普通输出：仅在有内容时写入结果并计数（避免空行增加块数）
    if (text.trim().length > 0) {
        document.getElementById('result').textContent = text + document.getElementById('result').textContent;
        receivedChunks++;
        // 仅更新明细，不在此处重绘进度百分比，避免与 progress 事件打架
        const detailEl = document.getElementById('progressDetail');
        detailEl.textContent = '';
    } else {
        // 保留分隔空行但不计块数
        document.getElementById('result').textContent = text + document.getElementById('result').textContent;
    }
});

// 监听后端 progress 事件（包含 matches, files_total, files_done）
// 进度节流（避免频繁 DOM 更新卡顿）
let lastProgressAt = 0;
const PROGRESS_THROTTLE_MS = 120;

socket.on('progress', data => {
    // 更新计数 - 使用后端提供的累积总数
    if (typeof data.matches === 'number') {
        matches = data.matches;  // 后端已经累积了所有文件的匹配数
        // 立即更新匹配数显示，确保用户看到最新的累积结果
        document.getElementById('matchDisplay').textContent = `匹配：${matches} 条`;
    }
    if (typeof data.files_total === 'number') {
        files_total = data.files_total;
    }
    if (typeof data.files_done === 'number') {
        files_done = data.files_done;
    }
    // 更新文件类型与耗时（如提供）
    if (data.file_type) {
        fileType = data.file_type;
    }
    
    if (data && data.phase === 'cancelled') {
        running = false;
        pendingSubmit = false;
        wasCancelled = true;
        setProgressState('cancelled');
        disableControls(false);
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => hideProgress(), 1200);
        return;
    }
    if (data && data.phase === 'error') {
        setProgressState('error', {msg: '出现错误'});
    }
    // 单进度条：优先根据字节进度（解压阶段）；否则按文件进度
    let pct = 0;
    if (typeof data.bytes_done === 'number') {
        const done = Math.max(0, data.bytes_done || 0);
        const total = Math.max(done, data.bytes_total || done);
        pct = total > 0 ? Math.floor((done / total) * 100) : 0;
    } else if (files_total && files_total > 0) {
        if (files_total === 1 && files_done === 0) {
            const fallbackChunks = Math.min(95, 5 + Math.floor(receivedChunks * 2));
            pct = fallbackChunks;
        } else {
            pct = Math.floor((files_done / files_total) * 100);
        }
    } else {
        pct = Math.min(95, 5 + Math.floor(receivedChunks * 2));
    }
    // clamp：运行中允许字节或文件完成达到 100%，否则最多 99%
    const reachedByteCompletion = (typeof data.bytes_done === 'number' && typeof data.bytes_total === 'number' && data.bytes_total > 0 && data.bytes_done >= data.bytes_total);
    const reachedFileCompletion = (files_total > 0 && files_done >= files_total);
    if (running && !(reachedByteCompletion || reachedFileCompletion)) {
        pct = Math.min(99, Math.max(0, pct));
    } else {
        pct = Math.min(100, Math.max(0, pct));
    }

    // 单调递增保护：避免不同基准切换导致进度回退
    if (running) {
        if (pct < lastVisualPct) {
            pct = lastVisualPct;
        } else {
            lastVisualPct = pct;
        }
    }

    // 新增：达到完成条件时立即切换为完成态（不受节流）
    if (reachedFileCompletion || ((fileType === 'compressed' || fileType === 'archive') && reachedByteCompletion)) {
        running = false;
        lastVisualPct = 100;
        setProgressState('done', {fileType, preserveBarStyle: (fileType === 'compressed')});
        disableControls(false);
        document.getElementById('submitBtn').disabled = false;
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => hideProgress(), 1200);
        return;
    }

    // 节流更新 UI（仅运行态）
    const now = Date.now();
    if (now - lastProgressAt >= PROGRESS_THROTTLE_MS) {
        lastProgressAt = now;
        const note = '检索中';
        setProgressState('running', {pct: pct, text: note});
    }
});

function sendKeyword() {
    const kw = document.getElementById('keyword').value.trim();
    if (!kw) {
        alert('请输入关键词后再提交！');
        return;
    }

    // 防抖 + 运行中防重复
    const now = Date.now();
    if (running || pendingSubmit || (now - lastSubmitAt < DEBOUNCE_MS)) {
        return;
    }
    lastSubmitAt = now;
    pendingSubmit = true;
    // 新搜索开始：清除取消标记，避免忽略后续 Started/Progress
    wasCancelled = false;

    const before = parseInt(document.getElementById('context_before').value || '0', 10);
    const after  = parseInt(document.getElementById('context_after').value || '0', 10);
    const file   = document.getElementById('file').value || '';

    // 更新文件类型 UI 与计时清零
    fileType = classifyFileType(file.toLowerCase());
    
    // 提交后立即允许取消
    document.getElementById('cancelBtn').disabled = false;

    // 立即显示进度，但仅暂时禁用提交按钮（其余控件待服务端确认后再禁用）
    receivedChunks = 0;
    matches = 0; // 新提交重置显示计数
    files_total = 0;
    files_done = 0;
    document.getElementById('matchDisplay').textContent = `匹配：${matches} 条`;
    showProgress();
    setProgressState('running', {pct:5, text: '已提交，等待结果...'});
    document.getElementById('submitBtn').disabled = true;

    // 使用 AbortController 支持取消当前检索请求
    searchController = new AbortController();
    fetch('/search', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({keyword: kw, context_before: before, context_after: after, file}),
        signal: searchController.signal
    }).catch(err => {
        // request failed or aborted
        pendingSubmit = false;
        running = false;
        setProgressState('error', {msg: '提交失败'});
        disableControls(false);
        document.getElementById('submitBtn').disabled = false;
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => { hideProgress(); }, 1200);
    });
}

function cancelSearch() {
    // 终止所有未完成的请求（不跟踪 /cancel）
    if (searchController) { try { searchController.abort(); } catch(e){} searchController = null; }
    cancelAllFetches();
    // 点击反馈：显示“取消中...”并短暂禁用取消按钮，明确操作已触发
    const badge = document.getElementById('progressBadge');
    if (badge) badge.textContent = '取消中...';
    const sp = document.getElementById('loadingSpinner');
    if (sp) sp.style.display = 'inline-block';
    const cancelBtn = document.getElementById('cancelBtn');
    if (cancelBtn) { cancelBtn.disabled = true; setTimeout(() => { cancelBtn.disabled = false; }, 800); }

    // 请求后端取消
    fetch('/cancel', {method: 'POST'}).catch(()=>{});

    // 本地 UI 重置
    running = false;
    pendingSubmit = false;
    wasCancelled = true;
    lastVisualPct = 100;
    setProgressState('cancelled');
    disableControls(false);
    document.getElementById('submitBtn').disabled = false;
    clearTimeout(progressHideTimeout);
    progressHideTimeout = setTimeout(() => { hideProgress(); }, 800);
}

function clearResult() {
    try {
        const res = document.getElementById('result');
        if (res) res.textContent = '';
        // 清空结果时同时重置匹配数显示为0
        matches = 0;
        document.getElementById('matchDisplay').textContent = `匹配：${matches} 条`;
        // 仅清除界面显示内容，不改变其他运行/计数状态
        // 不重置 files_total/files_done/receivedChunks，不操作进度条
    } catch (e) {
        // 静默处理前端清空异常，避免影响其他操作
        console.warn('clearResult error:', e);
    }
}

function exportResult() {
    const content = document.getElementById('result').textContent
                      .split('\n')
                      .filter(line => !line.includes('??? Cancelled ???'))
                      .join('\n');
    if (!content.trim()) {
        alert('检索结果为空，无需导出！');
        return;
    }
    const kw = document.getElementById('keyword').value.trim().replace(/[^\w\u4e00-\u9fa5\-_ ]/g, '');
    const fn = `${kw || 'search'}_${new Date().toISOString().slice(0,10)}_${Date.now()}.txt`;
    const blob = new Blob([content], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fn;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
}

window.addEventListener('beforeunload', () => cancelSearch());
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>文件内容检索系统</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        html, body { height: 100%; }
        .container { height: 100%; }
        #result {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: auto;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            max-height: calc(70vh);
            min-height: 200px;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
        }
        @media (max-width: 768px) {
            #result { max-height: calc(60vh); min-height: 150px; }
        }

        /* Progress box styling */
        .progress-wrap {
            margin-top: 12px;
            background: linear-gradient(180deg, #ffffff, #f7f9fb);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.04);
            display: none; /* hidden by default */
            align-items: center;
        }
        .progress-info {
            display:flex;
            align-items:center;
            gap:12px;
            width:100%;
        }
        .progress-label {
            min-width: 140px;
            font-size: 0.95rem;
            color:#495057;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .progress-status-badge {
            font-size: 0.75rem;
            padding: 0.25em 0.5em;
            border-radius: 999px;
        }
        /* Smooth progress bar animation */
        #progressBar { transition: width 220ms ease-in-out; }
        .no-transition { transition: none !important; }

        /* match display under title */
        #matchDisplay {
            font-weight: 600;
            color: #1f618d;
            margin-bottom: 8px;
        }

        /* small responsive spacing */
        @media (max-width: 576px) {
            .progress-label { min-width: 100px; font-size: 0.85rem; }
        }

        /* File name and percentage display styling */
        .progress-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
            font-size: 0.85rem;
            color: #6c757d;
        }
        #fileNameDisplay {
            font-size: 0.85rem;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
            <h2 class="text-center mb-2">文件内容检索系统</h2>

            <!-- 专属一行显示匹配数（居中、独占一行） -->
            <div id="matchDisplay" class="text-center">匹配：0 条</div>

            <form class="mb-2 px-2 py-3 bg-white rounded shadow-sm">
                <div class="row g-2 align-items-center">
                    <div class="col-12 col-md-5 mb-2 mb-md-0">
                        <input type="text" id="keyword" class="form-control" placeholder="输入关键词" style="font-size:1.1em;">
                    </div>
                    <div class="col-6 col-md-2">
                        <input type="number" id="context_before" class="form-control" placeholder="上文" min="0">
                    </div>
                    <div class="col-6 col-md-2">
                        <input type="number" id="context_after" class="form-control" placeholder="下文" min="0">
                    </div>
                    <div class="col-12 col-md-3 mt-2 mt-md-0">
                        <select id="file" class="form-control">
                            <option value="__ALL__" selected>检索全部文件</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3 g-2">
                    <div class="col-6 col-md-3">
                        <button type="button" id="submitBtn" class="btn btn-outline-primary w-100" onclick="sendKeyword()">提交</button>
                    </div>
                    <div class="col-6 col-md-3">
                        <button type="button" id="cancelBtn" class="btn btn-outline-danger w-100">取消</button>
                    </div>
                    <div class="col-6 col-md-3 mt-2 mt-md-0">
                        <button type="button" id="clearBtn" class="btn btn-outline-warning w-100" onclick="clearResult()">清空</button>
                    </div>
                    <div class="col-6 col-md-3 mt-2 mt-md-0">
                        <button type="button" id="exportBtn" class="btn btn-outline-secondary w-100" onclick="exportResult()">导出</button>
                    </div>
                </div>

                <!-- Progress area (hidden by default) -->
                <div id="progressWrap" class="progress-wrap mt-3">
                    <div class="progress-info w-100">
                        <div class="progress-label">
                            <strong id="progressTitle">检索进度</strong>
                            <span id="loadingSpinner" class="spinner-border spinner-border-sm text-secondary" style="display:none;" role="status" aria-hidden="true"></span>
                            <span id="progressBadge" class="badge badge-secondary progress-status-badge">空闲</span>
                        </div>
                        <div class="flex-fill">
                            <div class="progress" style="height:12px;">
                                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <!-- File name and percentage display area -->
                            <div class="progress-footer">
                                <div id="fileNameDisplay"></div>
                                <div id="progressPercent">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end progress -->
            </form>
            <pre id="result" class="mt-4"></pre>
        </div>
    </div>
</div>
<script>
var socket = io({path: '/io'});

let running = false;
let pendingSubmit = false;
let lastSubmitAt = 0;
const DEBOUNCE_MS = 600;
let receivedChunks = 0;
let matches = 0;
let files_total = 0;
let files_done = 0;
let progressHideTimeout = null;
let fileType = 'other';
let searchController = null;
const inflightControllers = new Set();
let wasCancelled = false;
let currentFileName = '';

function classifyFileType(nameLower) {
    const n = (nameLower || '').toLowerCase();
    if (/(\.zip|\.jar|\.war|\.rar|\.7z)$/i.test(n)) return 'archive';
    if (/(\.gz|\.bz2|\.xz|\.lz4|\.lzma)$/i.test(n)) return 'compressed';
    if (/\.xlsx$/i.test(n)) return 'excel';
    if (/\.xls$/i.test(n)) return 'excel';
    if (/\.csv$/i.test(n)) return 'csv';
    if (/(\.txt|\.log|\.json|\.xml|\.md|\.ini|\.yaml|\.yml)$/i.test(n)) return 'text';
    return 'other';
}

function showProgress() {
    document.getElementById('progressWrap').style.display = 'flex';
}
function hideProgress() {
    document.getElementById('progressWrap').style.display = 'none';
}
function trackedFetch(url, options = {}, track = true) {
    const controller = new AbortController();
    const opts = Object.assign({}, options, { signal: controller.signal });
    if (track) inflightControllers.add(controller);
    return fetch(url, opts).finally(() => {
        if (track) inflightControllers.delete(controller);
    });
}
function cancelAllFetches() {
    inflightControllers.forEach(ctrl => {
        try { ctrl.abort(); } catch (e) {}
    });
    inflightControllers.clear();
}
function setProgressState(state, opts = {}) {
    const bar = document.getElementById('progressBar');
    const badge = document.getElementById('progressBadge');
    const detail = document.getElementById('progressDetail');
    const percent = document.getElementById('progressPercent');
    const matchEl = document.getElementById('matchDisplay');
    const fileNameEl = document.getElementById('fileNameDisplay');

    if (state === 'idle') {
        bar.style.width = '0%';
        bar.className = 'progress-bar';
        bar.classList.remove('no-transition');
        badge.className = 'badge badge-secondary progress-status-badge';
        badge.textContent = '空闲';
        if (detail) detail.textContent = '';
        percent.textContent = '0%';
        fileNameEl.textContent = '';
        currentFileName = '';
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'none';
    } else if (state === 'running') {
        showProgress();
        let pct = typeof opts.pct === 'number' ? opts.pct : 0;
        pct = Math.max(0, Math.min(100, pct));
        bar.classList.remove('no-transition');
        bar.style.width = pct + '%';
        bar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-info';
        badge.className = 'badge badge-info progress-status-badge';
        badge.textContent = opts.text || '检索中';
        matchEl.textContent = `匹配：${matches} 条`;
        percent.textContent = pct + '%';
        if (opts.file) {
            currentFileName = opts.file;
            fileNameEl.textContent = `正在检索：${opts.file}`;
        }
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'inline-block';
    } else if (state === 'done') {
        if (opts && (opts.fileType === 'compressed' || opts.fileType === 'archive')) {
            bar.classList.add('no-transition');
        } else {
            bar.classList.remove('no-transition');
        }
        bar.style.width = '100%';
        if (opts && opts.preserveBarStyle) {
            bar.classList.remove('bg-info');
            bar.classList.add('bg-success');
        } else {
            bar.className = 'progress-bar bg-success';
        }
        badge.className = 'badge badge-success progress-status-badge';
        badge.textContent = '完成';
        matchEl.textContent = `匹配：${matches} 条`;
        percent.textContent = '100%';
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'none';
    } else if (state === 'cancelled') {
        bar.style.width = '100%';
        bar.className = 'progress-bar bg-danger';
        badge.className = 'badge badge-danger progress-status-badge';
        badge.textContent = '已取消';
        matchEl.textContent = `匹配：${matches} 条`;
        percent.textContent = '已取消';
        fileNameEl.textContent = '';
        currentFileName = '';
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'none';
    } else if (state === 'error') {
        showProgress();
        bar.style.width = '100%';
        bar.className = 'progress-bar bg-warning';
        badge.className = 'badge badge-warning progress-status-badge';
        badge.textContent = '错误';
        if (detail) detail.textContent = opts.msg || '出现错误';
        percent.textContent = '错误';
        fileNameEl.textContent = '';
        currentFileName = '';
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'none';
    }
}

function disableControls(val) {
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) submitBtn.disabled = val;
    const cancelBtn = document.getElementById('cancelBtn');
    if (cancelBtn) cancelBtn.disabled = false;
    const clearBtn = document.getElementById('clearBtn');
    if (clearBtn) clearBtn.disabled = false;
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) exportBtn.disabled = false;
}

window.addEventListener('DOMContentLoaded', function(){
    trackedFetch('/files', {}, true)
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(list => {
        const sel = document.getElementById('file');
        if (Array.isArray(list) && list.length > 0) {
            list.forEach(fn => {
                const opt = document.createElement('option');
                opt.value = fn; opt.textContent = fn;
                sel.appendChild(opt);
            });
        }
    }).catch(() => {});
    setProgressState('idle');
    const cancelBtnEl = document.getElementById('cancelBtn');
    cancelBtnEl.addEventListener('click', function(e){
        e.preventDefault();
        cancelSearch();
    });
});

socket.on('message', data => {
    if (!data || typeof data.message !== 'string') return;
    const text = data.message.replace(/\r?\n/g, '\n');

    if (text.includes('??? Cancelled ???')) {
        if (pendingSubmit) return;
        running = false;
        pendingSubmit = false;
        wasCancelled = true;
        setProgressState('cancelled');
        disableControls(false);
        document.getElementById('submitBtn').disabled = false;
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => hideProgress(), 1200);
        return;
    }

    if (text.includes('Started')) {
        if (!pendingSubmit) return;
        running = true;
        pendingSubmit = false;
        wasCancelled = false;
        receivedChunks = 0;
        matches = 0;
        files_total = 0;
        files_done = 0;
        document.getElementById('matchDisplay').textContent = `匹配：${matches} 条`;
        setProgressState('running', {pct:0, text: '开始检索'});
        disableControls(true);
        document.getElementById('cancelBtn').disabled = false;
        return;
    }

    if (text.includes('Busy')) {
        pendingSubmit = false;
        setProgressState('error', {msg: '服务器忙，请稍后再试'});
        disableControls(false);
        document.getElementById('submitBtn').disabled = false;
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => hideProgress(), 1200);
        return;
    }

    if (text.includes('Done')) {
        if (pendingSubmit) return;
        if (wasCancelled) return;
        running = false;
        pendingSubmit = false;
        setProgressState('done', {fileType, preserveBarStyle: (fileType === 'compressed')});
        disableControls(false);
        document.getElementById('submitBtn').disabled = false;
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => hideProgress(), 1200);
        return;
    }

    if (/^\s*\?\?/.test(text)) return;

    if (text.trim().length > 0) {
        document.getElementById('result').textContent = text + document.getElementById('result').textContent;
        receivedChunks++;
    } else {
        document.getElementById('result').textContent = text + document.getElementById('result').textContent;
    }
});

let lastProgressAt = 0;
const PROGRESS_THROTTLE_MS = 120;

socket.on('progress', data => {
    // 只在单文件检索时更新匹配数，多文件检索时由sendKeyword函数控制
    if (typeof data.matches === 'number' && document.getElementById('file').value !== '__ALL__') {
        matches = data.matches;
        // 避免在进度条更新过程中频繁更新匹配数显示
        if (!running || (Date.now() - lastProgressAt) >= PROGRESS_THROTTLE_MS) {
            document.getElementById('matchDisplay').textContent = `匹配：${matches} 条`;
        }
    }
    if (typeof data.files_total === 'number') files_total = data.files_total;
    if (typeof data.files_done === 'number') files_done = data.files_done;
    if (data.file_type) fileType = data.file_type;
    if (data && data.phase === 'cancelled') {
        if (pendingSubmit) return;
        running = false;
        pendingSubmit = false;
        wasCancelled = true;
        setProgressState('cancelled');
        disableControls(false);
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => hideProgress(), 1200);
        return;
    }
    if (data && data.phase === 'error') {
        setProgressState('error', {msg: '出现错误'});
    }
    let pct = 0;
    if (typeof data.bytes_done === 'number') {
        const done = Math.max(0, data.bytes_done || 0);
        const total = Math.max(done, data.bytes_total || done);
        pct = total > 0 ? Math.floor((done / total) * 100) : 0;
    } else if (files_total && files_total > 0) {
        if (files_total === 1 && files_done === 0) {
            const fallbackChunks = Math.min(95, Math.floor(receivedChunks * 2));
            pct = Math.max(fallbackChunks, 0);
        } else {
            pct = Math.floor((files_done / files_total) * 100);
        }
    } else {
        pct = Math.min(95, Math.floor(receivedChunks * 2));
    }
    const reachedByteCompletion = (typeof data.bytes_done === 'number' && typeof data.bytes_total === 'number' && data.bytes_total > 0 && data.bytes_done >= data.bytes_total);
    const reachedFileCompletion = (files_total > 0 && files_done >= files_total);
    if (running && !(reachedByteCompletion || reachedFileCompletion)) {
        pct = Math.min(99, Math.max(0, pct));
    } else {
        pct = Math.min(100, Math.max(0, pct));
    }
    if (reachedFileCompletion || ((fileType === 'compressed' || fileType === 'archive') && reachedByteCompletion)) {
        running = false;
        setProgressState('done', {fileType, preserveBarStyle: (fileType === 'compressed')});
        disableControls(false);
        document.getElementById('submitBtn').disabled = false;
        clearTimeout(progressHideTimeout);
        progressHideTimeout = setTimeout(() => hideProgress(), 1200);
        return;
    }
    const now = Date.now();
    if (now - lastProgressAt >= PROGRESS_THROTTLE_MS) {
        lastProgressAt = now;
        const note = '检索中';
        setProgressState('running', {pct: pct, text: note});
    }
});

async function sendKeyword() {
    const kw = document.getElementById('keyword').value.trim();
    if (!kw) { alert('请输入关键词'); return; }

    const now = Date.now();
    if (running || pendingSubmit || (now - lastSubmitAt < DEBOUNCE_MS)) return;
    lastSubmitAt = now;
    pendingSubmit = true;
    wasCancelled = false;

    const before = parseInt(document.getElementById('context_before').value || '0', 10);
    const after  = parseInt(document.getElementById('context_after').value || '0', 10);
    const fileSel = document.getElementById('file');
    const file = fileSel.value;

    if (file === '__ALL__') {
        const list = await trackedFetch('/files').then(r => r.ok ? r.json() : Promise.reject()).catch(() => []);
        if (!list.length) { alert('目录中没有可检索文件'); pendingSubmit = false; return; }
        
        // 初始化累计匹配数
        let totalMatches = 0;
        matches = 0;
        document.getElementById('matchDisplay').textContent = `匹配：${matches} 条`;
        
        for (const f of list) {
            if (wasCancelled) break;
            const fileMatches = await singleSearch(kw, before, after, f);
            if (typeof fileMatches === 'number') {
                totalMatches += fileMatches;
                matches = totalMatches;
                document.getElementById('matchDisplay').textContent = `匹配：${matches} 条`;
            }
            
            // 在进行下一个文件检索前添加1秒缓冲时间
            if (list.indexOf(f) < list.length - 1 && !wasCancelled) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
        pendingSubmit = false;
        return;
    }
    if (!file) { alert('请先选择文件'); pendingSubmit = false; return; }
    await singleSearch(kw, before, after, file);
}

async function singleSearch(kw, before, after, file) {
    fileType = classifyFileType(file.toLowerCase());
    receivedChunks = 0;
    let currentFileMatches = 0; // 当前文件的匹配数
    files_total = 0;
    files_done = 0;
    showProgress();
    setProgressState('running', {pct: 0, text: '检索中', file: file});
    document.getElementById('submitBtn').disabled = true;

    searchController = new AbortController();
    try {
        const resp = await fetch('/search', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({keyword: kw, context_before: before, context_after: after, file}),
            signal: searchController.signal
        });
        if (!resp.ok) throw new Error('search failed');
        
        // 等待搜索完成并获取匹配数
        await new Promise(resolve => {
            const onDone = () => { 
                socket.off('message', handler); 
                socket.off('progress', progressHandler);
                resolve(); 
            };
            const handler = (data) => {
                if (data.message && (data.message.includes('Done') || data.message.includes('Cancelled'))) onDone();
            };
            const progressHandler = (data) => {
                if (typeof data.matches === 'number') {
                    currentFileMatches = data.matches;
                }
            };
            socket.on('message', handler);
            socket.on('progress', progressHandler);
        });
        
        return currentFileMatches;
    } catch (e) {
        // 单条出错继续下一个
        return 0;
    }
}

function cancelSearch() {
    console.log('Canceling search...');
    
    // Abort any active fetch requests
    if (searchController) { 
        try { 
            searchController.abort(); 
        } catch(e){
            console.error('Error aborting search controller:', e);
        } 
        searchController = null; 
    }
    
    // Cancel all tracked fetch requests
    cancelAllFetches();
    
    // Update UI to show canceling state
    const badge = document.getElementById('progressBadge');
    if (badge) badge.textContent = '取消中...';
    const sp = document.getElementById('loadingSpinner');
    if (sp) sp.style.display = 'inline-block';
    
    // Send cancel request to backend
    fetch('/cancel', {method: 'POST'})
        .then(response => {
            console.log('Cancel request sent successfully');
        })
        .catch(error => {
            console.error('Error sending cancel request:', error);
        });
    
    // Update state
    running = false;
    pendingSubmit = false;
    wasCancelled = true;
    
    // Update UI
    setProgressState('cancelled');
    disableControls(false);
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) submitBtn.disabled = false;
    
    // Hide progress after delay
    clearTimeout(progressHideTimeout);
    progressHideTimeout = setTimeout(() => { hideProgress(); }, 800);
}

function clearResult() {
    try {
        const res = document.getElementById('result');
        if (res) res.textContent = '';
        matches = 0;
        document.getElementById('matchDisplay').textContent = `匹配：${matches} 条`;
    } catch (e) {
        console.warn('clearResult error:', e);
    }
}

function exportResult() {
    const content = document.getElementById('result').textContent
                      .split('\n')
                      .filter(line => !line.includes('??? Cancelled ???'))
                      .join('\n');
    if (!content.trim()) { alert('检索结果为空，无需导出！'); return; }
    const kw = document.getElementById('keyword').value.trim().replace(/[^\w\u4e00-\u9fa5\-_ ]/g, '');
    const fn = `${kw || 'search'}_${new Date().toISOString().slice(0,10)}_${Date.now()}.txt`;
    const blob = new Blob([content], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fn;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
}

window.addEventListener('beforeunload', () => cancelSearch());
</script>
</body>
</html>
